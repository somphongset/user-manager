<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVXNlciBNYW5hZ2VyIiwic2hvcnRfbmFtZSI6IlVzZXJNYW5hZ2VyIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiIn0=">
    <style>
        body { background-color: #f0f2f5; }
        .main-container { max-width: 900px; margin: 2rem auto; }
        .debug-panel { position: fixed; bottom: 0; left: 0; right: 0; height: 200px; background-color: #212529; color: #fff; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; z-index: 1050; border-top: 2px solid #ffc107; }
        .debug-content { white-space: pre-wrap; }
        .debug-toggle { position: fixed; bottom: 210px; right: 20px; z-index: 1051; }
        .table th { background-color: #e9ecef; }
        .spinner-border-sm { width: 1rem; height: 1rem; }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="login-view" class="main-container">
        <div class="card shadow-sm">
            <div class="card-body p-5">
                <h2 class="card-title text-center mb-4">เข้าสู่ระบบจัดการผู้ใช้</h2>
                <form id="login-form">
                    <div class="mb-3">
                        <label for="admin-email" class="form-label">เลือกผู้ดูแลระบบ</label>
                        <select class="form-select" id="admin-email" required>
                            <option value="" selected disabled>กำลังโหลด...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="admin-password" class="form-label">รหัสผ่าน</label>
                        <input type="password" class="form-control" id="admin-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <span class="login-spinner spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        เข้าสู่ระบบ
                    </button>
                </form>
                <div id="login-error" class="alert alert-danger mt-3 d-none"></div>
            </div>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view" class="main-container d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>จัดการผู้ใช้งาน</h2>
            <div>
                <span id="current-user" class="me-3"></span>
                <button class="btn btn-danger" onclick="logout()">ออกจากระบบ</button>
            </div>
        </div>

        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#createUserModal">
            <i class="bi bi-plus-circle"></i> สร้างผู้ใช้ใหม่
        </button>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>ชื่อผู้ใช้</th>
                                <th>บทบาท</th>
                                <th>สถานะ</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <tr>
                                <td colspan="5" class="text-center">กำลังโหลดข้อมูล...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">สร้างผู้ใช้ใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-user-form">
                        <div class="mb-3">
                            <label for="new-email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="new-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-password" class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-user-name" class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="new-user-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="new-user-role" class="form-label">บทบาท</label>
                            <select class="form-select" id="new-user-role" required>
                                <option value="user" selected>user</option>
                                <option value="admin">admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <span class="create-spinner spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขข้อมูลผู้ใช้</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-user-form">
                        <input type="hidden" id="edit-user-id">
                        <div class="mb-3">
                            <label for="edit-user-name" class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="edit-user-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-user-role" class="form-label">บทบาท</label>
                            <select class="form-select" id="edit-user-role" required>
                                <option value="user">user</option>
                                <option value="admin">admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="edit-user-status" class="form-label">สถานะ</label>
                            <select class="form-select" id="edit-user-status" required>
                                <option value="1">ใช้งานได้</option>
                                <option value="0">ปิดการใช้งาน</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <span class="edit-spinner spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        บันทึกการเปลี่ยนแปลง
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เปลี่ยนรหัสผ่าน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>เปลี่ยนรหัสผ่านสำหรับ: <strong id="password-target-email"></strong></p>
                    <form id="change-password-form">
                        <div class="mb-3">
                            <label for="new-password-input" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" class="form-control" id="new-password-input" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-warning" onclick="changeUserPassword()">
                        <span class="password-spinner spinner-border spinner-border-sm d-none me-2" role="status"></span>
                        เปลี่ยนรหัสผ่าน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <button class="btn btn-warning debug-toggle" onclick="toggleDebug()">Debug</button>
    <div id="debug-panel" class="debug-panel" style="display: none;">
        <div class="debug-content" id="debug-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // [01] CONFIGURATION
        const SUPABASE_URL = 'https://rjydgxebdalupktmnwlc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeWRneGViZGFsdXBrdG1ud2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTY2NDUsImV4cCI6MjA3NjYzMjY0NX0.-M2ABHEKeUldFwY4Hxb7RaRkB6rJqFnqY5eKlJSZEaM';
        const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/manage-users`;

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        // [02] DEBUG LOGGING
        function log(message, data = null) {
            const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
            const logMessage = `[${timestamp}] ${message}`;
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML += logMessage + '\n';
            debugContent.scrollTop = debugContent.scrollHeight;
            console.log(logMessage, data);
            if (data) {
                console.log(data);
                debugContent.innerHTML += JSON.stringify(data, null, 2) + '\n';
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // [03] AUTHENTICATION
        async function loadAdmins() {
            log('[AUTH] Loading admins for dropdown...');
            const { data, error } = await supabase
                .from('role_of_user')
                .select('email, user_name')
                .eq('user_role', 'admin')
                .eq('status', 1);

            if (error) {
                log('[AUTH] Error loading admins:', error);
                return;
            }
            const select = document.getElementById('admin-email');
            select.innerHTML = '<option value="" selected disabled>เลือกผู้ดูแลระบบ...</option>';
            data.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.email;
                option.textContent = `${admin.user_name} (${admin.email})`;
                select.appendChild(option);
            });
            log('[AUTH] Admins loaded successfully.', data);
        }

        async function login(email, password) {
            log('[AUTH] Attempting login...', { email });
            document.querySelector('.login-spinner').classList.remove('d-none');
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                log('[AUTH] Login failed:', error);
                document.getElementById('login-error').textContent = error.message;
                document.getElementById('login-error').classList.remove('d-none');
            } else {
                log('[AUTH] Login successful.', data);
                currentUser = data.user;
                showMainView();
            }
            document.querySelector('.login-spinner').classList.add('d-none');
        }

        async function logout() {
            log('[AUTH] Logging out...');
            await supabase.auth.signOut();
            currentUser = null;
            showLoginView();
        }

        async function checkSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                log('[AUTH] Existing session found.', session);
                currentUser = session.user;
                showMainView();
            } else {
                log('[AUTH] No existing session.');
                showLoginView();
            }
        }

        // [04] VIEW MANAGEMENT
        function showLoginView() {
            document.getElementById('login-view').classList.remove('d-none');
            document.getElementById('main-view').classList.add('d-none');
            loadAdmins();
        }

        function showMainView() {
            document.getElementById('login-view').classList.add('d-none');
            document.getElementById('main-view').classList.remove('d-none');
            document.getElementById('current-user').textContent = `สวัสดี, ${currentUser.email}`;
            loadUsers();
        }

        // [05] USER MANAGEMENT (from role_of_user)
        async function loadUsers() {
            log('[USER] Loading all users...');
            const { data, error } = await supabase
                .from('role_of_user')
                .select('*')
                .order('user_name');

            if (error) {
                log('[USER] Error loading users:', error);
                return;
            }
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            data.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.email}</td>
                    <td>${user.user_name}</td>
                    <td><span class="badge bg-primary">${user.user_role}</span></td>
                    <td><span class="badge bg-${user.status === 1 ? 'success' : 'secondary'}">${user.status === 1 ? 'ใช้งานได้' : 'ปิดการใช้งาน'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showEditUserModal('${user.user_id}', '${user.user_name}', '${user.user_role}', '${user.status}')">แก้ไข</button>
                        <button class="btn btn-sm btn-outline-warning" onclick="showChangePasswordModal('${user.email}')">เปลี่ยนรหัสผ่าน</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            log('[USER] Users loaded successfully.', data);
        }

        async function updateUser() {
            log('[USER] Updating user...');
            document.querySelector('.edit-spinner').classList.remove('d-none');
            const userId = document.getElementById('edit-user-id').value;
            const updates = {
                user_name: document.getElementById('edit-user-name').value,
                user_role: document.getElementById('edit-user-role').value,
                status: parseInt(document.getElementById('edit-user-status').value),
            };

            const { error } = await supabase
                .from('role_of_user')
                .update(updates)
                .eq('user_id', userId);

            if (error) {
                log('[USER] Error updating user:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } else {
                log('[USER] User updated successfully.', updates);
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                loadUsers();
            }
            document.querySelector('.edit-spinner').classList.add('d-none');
        }

        function showEditUserModal(userId, userName, userRole, status) {
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-user-name').value = userName;
            document.getElementById('edit-user-role').value = userRole;
            document.getElementById('edit-user-status').value = status;
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function showChangePasswordModal(email) {
            document.getElementById('password-target-email').textContent = email;
            document.getElementById('new-password-input').value = '';
            new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
        }

        // [06] SECURE OPERATIONS (via Edge Function)
        async function createUser() {
            log('[SECURE] Creating new user via Edge Function...');
            document.querySelector('.create-spinner').classList.remove('d-none');
            const payload = {
                email: document.getElementById('new-email').value,
                password: document.getElementById('new-password').value,
                user_name: document.getElementById('new-user-name').value,
                user_role: document.getElementById('new-user-role').value,
            };

            const { data, error } = await supabase.functions.invoke('manage-users', {
                body: { action: 'create-user', ...payload },
                headers: { Authorization: `Bearer ${currentUser.session.access_token}` }
            });

            if (error) {
                log('[SECURE] Error creating user:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } else {
                log('[SECURE] User created successfully.', data);
                bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
                document.getElementById('create-user-form').reset();
                loadUsers();
            }
            document.querySelector('.create-spinner').classList.add('d-none');
        }

        async function changeUserPassword() {
            log('[SECURE] Changing password via Edge Function...');
            document.querySelector('.password-spinner').classList.remove('d-none');
            const payload = {
                email: document.getElementById('password-target-email').textContent,
                new_password: document.getElementById('new-password-input').value,
            };

            const { data, error } = await supabase.functions.invoke('manage-users', {
                body: { action: 'change-password', ...payload },
                headers: { Authorization: `Bearer ${currentUser.session.access_token}` }
            });

            if (error) {
                log('[SECURE] Error changing password:', error);
                alert('เกิดข้อผิดพลาด: ' + error.message);
            } else {
                log('[SECURE] Password changed successfully.', data);
                bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                alert('เปลี่ยนรหัสผ่านสำเร็จแล้ว');
            }
            document.querySelector('.password-spinner').classList.add('d-none');
        }

        // [07] EVENT LISTENERS
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            login(email, password);
        });

        // [08] INITIALIZATION
        document.addEventListener('DOMContentLoaded', () => {
            log('APP INITIALIZED');
            checkSession();
        });
    </script>
</body>
</html>