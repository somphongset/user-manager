<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Manager Zai</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVXNlciBNYW5hZ2VyIFphaSIsInNob3J0X25hbWUiOiJVc2VyTWFuIiwic3RhcnRfdXJsIjoiLi8iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIn0=">
    <meta name="theme-color" content="#ffffff">
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .main-container { max-width: 1200px; margin: auto; margin-top: 2rem; }
        .debug-pane { background-color: white; border: 1px solid #dee2e6; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; padding: 10px; }
        .message-pane { min-height: 50px; }
        .table-responsive { margin-top: 1rem; }
        .action-buttons .btn { margin-right: 5px; }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="loginView" class="container main-container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title text-center mb-4">เข้าสู่ระบบ</h3>
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="adminSelect" class="form-label">ผู้ใช้งาน</label>
                                <select class="form-select" id="adminSelect" required>
                                    <option value="" selected disabled>กำลังโหลด...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="passwordInput" class="form-label">รหัสผ่าน</label>
                                <input type="password" class="form-control" id="passwordInput" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">เข้าสู่ระบบ</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard View -->
    <div id="mainView" class="container main-container" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>จัดการผู้ใช้งาน</h2>
            <div>
                <span id="loggedInUser" class="me-3"></span>
                <button class="btn btn-success" id="btnCreateUser">สร้างผู้ใช้ใหม่</button>
                <button class="btn btn-secondary" id="btnLogout">ออกจากระบบ</button>
            </div>
        </div>

        <!-- Search/Filter Bar -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="ค้นหาตามอีเมลหรือชื่อ...">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="roleFilter">
                            <option value="">ทุกบทบาท</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="statusFilter">
                            <option value="">ทุกสถานะ</option>
                            <option value="1">ใช้ได้</option>
                            <option value="0">ห้ามใช้</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>ชื่อผู้ใช้</th>
                                <th>บทบาท</th>
                                <th>สถานะ</th>
                                <th>อัปเดตล่าสุด</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- User rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Pane -->
    <div class="container main-container">
        <div id="messagePane" class="message-pane alert alert-info" role="alert" style="display: none;"></div>
    </div>

    <!-- Debug Pane -->
    <div class="container main-container">
        <h5>Debug Pane</h5>
        <div id="debugPane" class="debug-pane"></div>
    </div>

    <!-- Modals -->
    <!-- Create/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">สร้างผู้ใช้ใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="modalUserId">
                        <div class="mb-3">
                            <label for="modalEmail" class="form-label">อีเมล</label>
                            <input type="email" class="form-control" id="modalEmail" required>
                        </div>
                        <div class="mb-3" id="passwordField">
                            <label for="modalPassword" class="form-label">รหัสผ่าน</label>
                            <input type="password" class="form-control" id="modalPassword">
                        </div>
                        <div class="mb-3" id="confirmPasswordField">
                            <label for="modalConfirmPassword" class="form-label">ยืนยันรหัสผ่าน</label>
                            <input type="password" class="form-control" id="modalConfirmPassword">
                        </div>
                        <div class="mb-3">
                            <label for="modalUserName" class="form-label">ชื่อผู้ใช้</label>
                            <input type="text" class="form-control" id="modalUserName" required>
                        </div>
                        <div class="mb-3">
                            <label for="modalUserRole" class="form-label">บทบาท</label>
                            <select class="form-select" id="modalUserRole" required>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3" id="statusField">
                            <label for="modalStatus" class="form-label">สถานะ</label>
                            <select class="form-select" id="modalStatus">
                                <option value="1">ใช้ได้</option>
                                <option value="0">ห้ามใช้</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="btnSaveUser">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ยืนยันการลบ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>คุณแน่ใจหรือไม่ที่จะลบผู้ใช้ <strong id="deleteUserName"></strong>?</p>
                    <p class="text-danger">การกระทำนี้ไม่สามารถย้อนกลับได้</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-danger" id="btnConfirmDelete">ลบ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">เปลี่ยนรหัสผ่าน</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>เปลี่ยนรหัสผ่านสำหรับ: <strong id="resetPasswordUserName"></strong></p>
                    <form id="resetPasswordForm">
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">รหัสผ่านใหม่</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmNewPassword" class="form-label">ยืนยันรหัสผ่านใหม่</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-warning" id="btnConfirmResetPassword">เปลี่ยนรหัสผ่าน</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Main Application Script -->
    <script>
        // This is the main application logic, wrapped in a function.
        // It will only be called after we are sure the Supabase library is ready.
        function startApp() {
            // [INIT-01] Initialize Supabase Client
            const SUPABASE_URL = 'https://rjydgxebdalupktmnwlc.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeWRneWViZGFsdXBrdG1ud2xjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNTY2NDUsImV4cCI6MjA3NjYzMjY0NX0.-M2ABHEKeUldFwY4Hxb7RaRkB6rJqFnqY5eKlJSZEaM';
            
            // Final check before proceeding
            if (typeof createClient === 'undefined') {
                document.getElementById('debugPane').innerHTML = 'FATAL ERROR: Supabase client library failed to load. Please check your network connection.';
                return;
            }
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Global variables
            let currentUser = null;
            let allUsers = [];
            let editingUserId = null;

            // DOM Elements
            const loginView = document.getElementById('loginView');
            const mainView = document.getElementById('mainView');
            const loginForm = document.getElementById('loginForm');
            const adminSelect = document.getElementById('adminSelect');
            const loggedInUserSpan = document.getElementById('loggedInUser');
            const messagePane = document.getElementById('messagePane');
            const debugPane = document.getElementById('debugPane');
            const userTableBody = document.getElementById('userTableBody');
            const userModal = new bootstrap.Modal(document.getElementById('userModal'));
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const resetPasswordModal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));

            // --- UTILITY FUNCTIONS ---
            function logDebug(message, data = null) {
                const timestamp = new Date().toLocaleTimeString('th-TH', { hour12: false });
                const logEntry = `[${timestamp}] ${message}`;
                console.log(logEntry, data);
                debugPane.innerHTML += logEntry + (data ? `<br><pre>${JSON.stringify(data, null, 2)}</pre>` : '') + '<hr>';
                debugPane.scrollTop = debugPane.scrollHeight;
            }

            function showMessage(text, type = 'info') {
                messagePane.textContent = text;
                messagePane.className = `message-pane alert alert-${type}`;
                messagePane.style.display = 'block';
                setTimeout(() => { messagePane.style.display = 'none'; }, 5000);
            }

            function formatTimestamp(utcString) {
                if (!utcString) return '-';
                const date = new Date(utcString);
                const bangkokDate = new Date(date.getTime() + (7 * 60 * 60 * 1000));
                return bangkokDate.toLocaleString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            }

            // --- AUTH & USER LOADING ---
            async function loadAdminsForLogin() {
                logDebug('Fetching admin users for login...');
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('user_email, user_name')
                    .eq('user_role', 'admin')
                    .eq('status', 1);

                if (error) {
                    logDebug('Error fetching admins', error);
                    showMessage('ไม่สามารถโหลดรายชื่อผู้ดูแลระบบได้', 'danger');
                    return;
                }
                adminSelect.innerHTML = '<option value="" selected disabled>เลือกผู้ใช้งาน...</option>';
                data.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.user_email;
                    option.textContent = admin.user_name;
                    adminSelect.appendChild(option);
                });
                logDebug('Admins loaded successfully', data);
            }

            async function handleLogin(event) {
                event.preventDefault();
                const email = adminSelect.value;
                const password = document.getElementById('passwordInput').value;
                logDebug(`Attempting to sign in as ${email}`);
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    logDebug('Login failed', error);
                    showMessage('เข้าสู่ระบบล้มเหลว: ' + error.message, 'danger');
                    return;
                }
                currentUser = data.user;
                logDebug('Login successful', currentUser);
                showMessage('เข้าสู่ระบบสำเร็จ', 'success');
                showMainView();
            }

            async function handleLogout() {
                logDebug('Signing out...');
                const { error } = await supabase.auth.signOut();
                if (error) { logDebug('Logout error', error); }
                currentUser = null;
                showLoginView();
                showMessage('ออกจากระบบแล้ว', 'info');
            }

            // --- VIEW MANAGEMENT ---
            function showLoginView() { loginView.style.display = 'block'; mainView.style.display = 'none'; }
            function showMainView() {
                loginView.style.display = 'none';
                mainView.style.display = 'block';
                loggedInUserSpan.textContent = `สวัสดี, ${currentUser.email}`;
                loadUsers();
            }

            // --- USER CRUD OPERATIONS ---
            async function loadUsers() {
                logDebug('Loading all users...');
                const { data, error } = await supabase.from('user_profiles').select('*').order('act_when', { ascending: false });
                if (error) { logDebug('Error loading users', error); showMessage('โหลดข้อมูลผู้ใช้ล้มเหลว', 'danger'); return; }
                allUsers = data;
                renderUserTable(data);
                logDebug('Users loaded', data);
            }

            function renderUserTable(users) {
                userTableBody.innerHTML = '';
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.user_email}</td>
                        <td>${user.user_name}</td>
                        <td><span class="badge bg-${user.user_role === 'admin' ? 'danger' : 'primary'}">${user.user_role}</span></td>
                        <td><span class="badge bg-${user.status === 1 ? 'success' : 'secondary'}">${user.status === 1 ? 'ใช้ได้' : 'ห้ามใช้'}</span></td>
                        <td>${formatTimestamp(user.act_when)}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditUserModal('${user.user_id}')">แก้ไข</button>
                            <button class="btn btn-sm btn-outline-warning" onclick="openResetPasswordModal('${user.user_id}', '${user.user_name}')">เปลี่ยนรหัสผ่าน</button>
                            <button class="btn btn-sm btn-outline-danger" onclick="openDeleteModal('${user.user_id}', '${user.user_name}')">ลบ</button>
                        </td>`;
                    userTableBody.appendChild(row);
                });
            }

            // --- MODAL HANDLERS ---
            function openCreateUserModal() {
                editingUserId = null; document.getElementById('userModalTitle').textContent = 'สร้างผู้ใช้ใหม่'; document.getElementById('userForm').reset();
                document.getElementById('modalUserRole').value = 'user'; document.getElementById('modalStatus').value = '1';
                document.getElementById('passwordField').style.display = 'block'; document.getElementById('confirmPasswordField').style.display = 'block';
                document.getElementById('statusField').style.display = 'block'; userModal.show();
            }
            function openEditUserModal(userId) {
                logDebug(`Opening edit modal for user ${userId}`); editingUserId = userId;
                const user = allUsers.find(u => u.user_id === userId); if (!user) return;
                document.getElementById('userModalTitle').textContent = 'แก้ไขข้อมูลผู้ใช้';
                document.getElementById('modalUserId').value = user.user_id; document.getElementById('modalEmail').value = user.user_email;
                document.getElementById('modalUserName').value = user.user_name; document.getElementById('modalUserRole').value = user.user_role;
                document.getElementById('modalStatus').value = user.status; document.getElementById('passwordField').style.display = 'none';
                document.getElementById('confirmPasswordField').style.display = 'none'; document.getElementById('statusField').style.display = 'block';
                userModal.show();
            }
            async function handleSaveUser() {
                const email = document.getElementById('modalEmail').value; const userName = document.getElementById('modalUserName').value;
                const userRole = document.getElementById('modalUserRole').value; const status = document.getElementById('modalStatus').value;
                if (editingUserId) {
                    const payload = { user_id: editingUserId, user_email: email, user_name: userName, user_role: userRole, status: parseInt(status) };
                    logDebug('Updating user', payload);
                    const { data, error } = await supabase.functions.invoke('update-user-profile', { body: payload, headers: { Authorization: `Bearer ${currentUser.session.access_token}` } });
                    if (error) { logDebug('Update user error', error); showMessage('แก้ไขผู้ใช้ล้มเหลว: ' + error.message, 'danger'); }
                    else { logDebug('Update user success', data); showMessage('แก้ไขผู้ใช้สำเร็จ', 'success'); userModal.hide(); loadUsers(); }
                } else {
                    const password = document.getElementById('modalPassword').value; const confirmPassword = document.getElementById('modalConfirmPassword').value;
                    if (password !== confirmPassword) { showMessage('รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน', 'warning'); return; }
                    const payload = { email, password, user_name: userName, user_role: userRole };
                    logDebug('Creating user', payload);
                    const { data, error } = await supabase.functions.invoke('create-user', { body: payload, headers: { Authorization: `Bearer ${currentUser.session.access_token}` } });
                    if (error) { logDebug('Create user error', error); showMessage('สร้างผู้ใช้ล้มเหลว: ' + error.message, 'danger'); }
                    else { logDebug('Create user success', data); showMessage('สร้างผู้ใช้สำเร็จ', 'success'); userModal.hide(); loadUsers(); }
                }
            }
            function openDeleteModal(userId, userName) {
                document.getElementById('deleteUserName').textContent = userName;
                document.getElementById('btnConfirmDelete').onclick = () => handleDeleteUser(userId);
                deleteModal.show();
            }
            async function handleDeleteUser(userId) {
                logDebug(`Deleting user ${userId}`);
                const { data, error } = await supabase.functions.invoke('delete-user', { body: { user_id: userId }, headers: { Authorization: `Bearer ${currentUser.session.access_token}` } });
                if (error) { logDebug('Delete user error', error); showMessage('ลบผู้ใช้ล้มเหลว: ' + error.message, 'danger'); }
                else { logDebug('Delete user success', data); showMessage('ลบผู้ใช้สำเร็จ', 'success'); deleteModal.hide(); loadUsers(); }
            }
            function openResetPasswordModal(userId, userName) {
                document.getElementById('resetPasswordUserName').textContent = userName; document.getElementById('resetPasswordForm').reset();
                document.getElementById('btnConfirmResetPassword').onclick = () => handleResetPassword(userId);
                resetPasswordModal.show();
            }
            async function handleResetPassword(userId) {
                const newPassword = document.getElementById('newPassword').value; const confirmNewPassword = document.getElementById('confirmNewPassword').value;
                if (newPassword !== confirmNewPassword) { showMessage('รหัสผ่านใหม่และยืนยันรหัสผ่านไม่ตรงกัน', 'warning'); return; }
                logDebug(`Resetting password for user ${userId}`);
                const { data, error } = await supabase.functions.invoke('reset-user-password', { body: { user_id: userId, new_password: newPassword }, headers: { Authorization: `Bearer ${currentUser.session.access_token}` } });
                if (error) { logDebug('Reset password error', error); showMessage('เปลี่ยนรหัสผ่านล้มเหลว: ' + error.message, 'danger'); }
                else { logDebug('Reset password success', data); showMessage('เปลี่ยนรหัสผ่านสำเร็จ', 'success'); resetPasswordModal.hide(); }
            }

            // --- EVENT LISTENERS ---
            loginForm.addEventListener('submit', handleLogin);
            document.getElementById('btnLogout').addEventListener('click', handleLogout);
            document.getElementById('btnCreateUser').addEventListener('click', openCreateUserModal);
            document.getElementById('btnSaveUser').addEventListener('click', handleSaveUser);
            function applyFilters() {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const roleFilter = document.getElementById('roleFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;
                const filteredUsers = allUsers.filter(user => {
                    const matchesSearch = user.user_email.toLowerCase().includes(searchTerm) || user.user_name.toLowerCase().includes(searchTerm);
                    const matchesRole = !roleFilter || user.user_role === roleFilter;
                    const matchesStatus = statusFilter === '' || user.status === parseInt(statusFilter);
                    return matchesSearch && matchesRole && matchesStatus;
                });
                renderUserTable(filteredUsers);
            }
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('roleFilter').addEventListener('change', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);

            // --- INITIALIZATION ---
            logDebug('App Initialized. Starting initial load.');
            loadAdminsForLogin();
            showLoginView();
        }

        // --- Dynamic Script Loading (Final Simplified Version) ---
        // This function will load the Supabase library using the most standard method.
        function loadSupabaseAndStartApp() {
            const script = document.createElement('script');
            // Use the most standard and reliable URL for Supabase JS
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.onload = () => {
                console.log('Supabase script loaded. Waiting for createClient to be available...');
                let checkCount = 0;
                const maxChecks = 100; // 100 * 50ms = 5 seconds

                const checkInterval = setInterval(() => {
                    checkCount++;
                    // Use window.createClient to be explicit
                    if (typeof window.createClient !== 'undefined') {
                        clearInterval(checkInterval);
                        console.log('createClient is now available. Starting app.');
                        startApp();
                    } else if (checkCount > maxChecks) {
                        clearInterval(checkInterval);
                        console.error('Timed out waiting for Supabase library to become available.');
                        document.getElementById('debugPane').innerHTML = 'FATAL ERROR: Timed out waiting for the Supabase library. This is an unusual issue. Please try refreshing the page.';
                    }
                }, 50); // Check every 50ms
            };
            script.onerror = (e) => {
                console.error('Failed to load Supabase library from jsdelivr.', e);
                document.getElementById('debugPane').innerHTML = 'FATAL ERROR: Could not download the Supabase library from the CDN. Please check your internet connection.';
            };
            document.head.appendChild(script);
        }

        // Start the loading process when the page is ready.
        document.addEventListener('DOMContentLoaded', loadSupabaseAndStartApp);

    </script>
</body>
</html>
